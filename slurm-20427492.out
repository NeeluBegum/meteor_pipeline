...Fri Jun 11 13:04:31 CEST 2021: - begin running script
#!/bin/bash -l
#SBATCH --account=snic2021-5-248
#SBATCH --partition=core
#SBATCH --ntasks=10
#SBATCH --time=2-06:00:00
#SBATCH --job-name=FMT_last_batch
##SBATCH --output=%j 
##SBATCH --mail-user=zn.tportlock@gmail.com
##SBATCH --mail-type=ALL

function Run {
	start=$(date +%M)
	echo "...$(date): $1 - begin"; echo ""
	$@ \
	&& (echo "...$(date): $1 - done") \
	|| (echo "...$(date): $1 - failed")
	end=$(date +%M)
	echo "...time taken: $((end-start))"; echo ""
}
function Parse_variables {
	sampleId=$(basename $sample .fastq.gz)
	v_project_dir="$TMPDIR"
	v_prefix=$( grep "meteor.counting.prefix.name" $ini_file | sed "s/^.*=//g" )
	v_workdir="${v_project_dir}/working"
	v_refdir="${v_project_dir}/reference"
	v_fastqgz1="$(readlink -f $seq_data_dir/${sample}${forward_identifier})"
	v_fastqgz2="$(readlink -f $seq_data_dir/${sample}${reverse_identifier})"
	v_fastqgz1_unzip="${v_workdir}/$(basename $v_fastqgz1 .gz).unzipped"
	v_fastqgz2_unzip="${v_workdir}/$(basename $v_fastqgz2 .gz).unzipped"
	v_trimmedS="${v_workdir}/${sampleId}.trimmed.s.fastq"
	v_final1="${v_workdir}/${sampleId}_1.fastq"
	v_final2="${v_workdir}/${sampleId}_2.fastq"
	v_sampledir="${v_project_dir}/${catalog_type}/sample/${sampleId}"
	vars="$(compgen -A variable | grep "^v_.*")"
	for var in ${vars}; do echo "${var}=${!var}"; done
	for var in ${vars}; do if [[ -z "${!var}" ]]; then echo "missing argument ${var}" ; return 1 ; fi ; done
}
function Init {
	mkdir -p ${v_project_dir}/${catalog_type}/{sample,mapping,profiles}
	mkdir -p ${v_workdir}
	mkdir -p ${v_refdir}
}
function Send {
	cp $v_fastqgz1 $v_workdir
	cp $v_fastqgz2 $v_workdir
	cp -r ${reference_dir}/* $v_refdir
	cp -r $trimFasta $v_project_dir
}
function Decompress {
	zcat ${v_workdir}/$(basename $v_fastqgz1) > $v_fastqgz1_unzip & pid1=$!
	zcat ${v_workdir}/$(basename $v_fastqgz2) > $v_fastqgz2_unzip & pid2=$!
	trap "kill -2 $pid1 $pid2" SIGINT
	wait
}
function Trim {
	[[ -f $v_fastqgz1_unzip && -f $v_fastqgz2_unzip ]] \
	|| (echo "zip file not found" ; return 1 )
	java -jar ${ALIEN_TRIMMER}/AlienTrimmer.jar \
		-k 10 -l 45 -m 5 -p 40 -q 20 \
		-if ${v_fastqgz1_unzip} -ir ${v_fastqgz2_unzip} -c $TMPDIR/$(basename $trimFasta) \
		-of ${v_final1} -or ${v_final2} -os ${v_trimmedS} \
	|| return 1
}
function Import {
	[[ -f $v_final1 && -f $v_final2 ]] \
	|| (echo "trimmed files not found" ; return 1 )
	mv ${v_final1} ${v_final2} ${v_project_dir}/${catalog_type}/sample &&
	rm -r ${v_workdir}
	ruby ${meteorImportScript} \
		-i ${v_project_dir}/${catalog_type}/sample \
		-p ${catalog_type} \
		-t ${seq_platform} \
		-m "${sampleId}*" \
	|| return 1
}
function Map_reads {
	ruby ${meteor}/meteor.rb \
		-w ${ini_file} \
		-i ${v_sampledir} \
		-p ${v_project_dir}/${catalog_type} \
		-o mapping \
	|| return 1
}
function Quantify {
	${meteor}/meteor-profiler \
		-p ${v_project_dir}/${catalog_type} \
		-f ${v_project_dir}/${catalog_type}/profiles \
		-t smart_shared_reads \
		-w ${ini_file} \
		-o ${sampleId} ${v_project_dir}/${catalog_type}/mapping/${sampleId}/${sampleId}_${v_prefix}_gene_profile/census.dat \
	&& rm -r ${v_project_dir}/${catalog_type}/mapping/${sampleId} \
	|| return 1
}
function Recover {
	rsync -aurvP --remove-source-files $v_project_dir/ $project_dir_rel
}

Main() {
	Run Parse_variables &&
	Run Init &&
	Run Send &&
	Run Decompress &&
	Run Trim &&
	Run Import &&
	Run Map_reads &&
	Run Quantify &&
	Run Recover
}

echo "...$(date): - begin running script"
cat $0
echo ""

# Load modules
echo "...$(date): - load modules"
module load bioinfo-tools
module load ruby/2.6.2
module load AlienTrimmer/0.4.0
module load bowtie2/2.3.4.1
echo "...$(date): - done"; echo "" 

# Load ini file
echo "...$(date): - load ini file"
echo $TMPDIR/$(basename $1)
sed "s|meteor.reference.dir=.*|meteor.reference.dir=$TMPDIR/reference|g" $1 > $TMPDIR/$(basename $1)
ini_file=$TMPDIR/$(basename $1)
source $ini_file > /dev/null 2>&1
cat $ini_file
echo "...$(date): - done"; echo "" 

# Run
Main

...Fri Jun 11 13:04:31 CEST 2021: - load modules
Bowtie2 looks for the specified index first in the current directory, then in the directory specified in the BOWTIE2_INDEXES environment variable.
The pregenerated indexes for the reference genonomes are placed under /sw/data/reference/*/*/program_files/bowtie2 for each reference genome
...Fri Jun 11 13:04:38 CEST 2021: - done

...Fri Jun 11 13:04:38 CEST 2021: - load ini file
/scratch/20427492/P18161_249_S120_L004.ini
[Pipeline]
sample=P18161_249/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_249_S120_L004
forward_identifier="_R1_001.fastq.gz"
reverse_identifier="_R2_001.fastq.gz"
seq_data_dir="/proj/snic2020-6-153/delivery04021/P18161"
project_dir_rel="/proj/uppstore2019028/projects/metagenome/theo/newscripts/tmp"
catalog_type="oral_catalog"
seq_platform="illumina"
trimFasta="/proj/uppstore2019028/projects/metagenome/alienTrimmerPF8contaminants.fasta"
meteorImportScript="/proj/uppstore2019028/meteor.2019.11.04/MeteorImportFastq.rb"
meteor="/proj/uppstore2019028/projects/metagenome/software/meteor_linux_2019.11.04"
Rdir="/proj/uppstore2019028/projects/metagenome/meteor_downstream_rscripts"
reference_dir="/proj/uppstore2019028/projects/metagenome/meteor_ref"
[worksession]
meteor.reference.dir=/scratch/20427492/reference
meteor.db.type=binary
meteor.nb.attempts=3
meteor.read.cleaning.program=none
meteor.read.cleaning.cmd=
meteor.mapping.program=bowtie2
meteor.mapping.file.format=sam
meteor.is.cpu.percentage=0
meteor.cpu.count=10
meteor.checksum=md5
meteor.excluded.reference.count=3
[main_reference]
meteor.reference.name=oral_catalog
meteor.matches=10000
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapper.cmd=
meteor.mapping.prefix.name=mapping_vs_oral_catalog
meteor.counting.prefix.name=vs_hs_10_4_oral_catalog
[excluded_reference_1]
meteor.reference.name=Homo_sapiens_GRCh38
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Homo_sapiens_GRCh38
[excluded_reference_2]
meteor.reference.name=A_thaliana_TAIR10
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_A_thaliana_TAIR10
[excluded_reference_3]
meteor.reference.name=Bos_taurus_UMD3
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Bos_taurus_UMD3
...Fri Jun 11 13:04:38 CEST 2021: - done

...Fri Jun 11 13:04:38 CEST 2021: Parse_variables - begin

v_fastqgz1=/crex/proj/snic2020-6-153/nobackup/delivery04021/P18161/P18161_249/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_249_S120_L004_R1_001.fastq.gz
v_fastqgz1_unzip=/scratch/20427492/working/P18161_249_S120_L004_R1_001.fastq.unzipped
v_fastqgz2=/crex/proj/snic2020-6-153/nobackup/delivery04021/P18161/P18161_249/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_249_S120_L004_R2_001.fastq.gz
v_fastqgz2_unzip=/scratch/20427492/working/P18161_249_S120_L004_R2_001.fastq.unzipped
v_final1=/scratch/20427492/working/P18161_249_S120_L004_1.fastq
v_final2=/scratch/20427492/working/P18161_249_S120_L004_2.fastq
v_prefix=vs_hs_10_4_oral_catalog
v_project_dir=/scratch/20427492
v_refdir=/scratch/20427492/reference
v_sampledir=/scratch/20427492/oral_catalog/sample/P18161_249_S120_L004
v_trimmedS=/scratch/20427492/working/P18161_249_S120_L004.trimmed.s.fastq
v_workdir=/scratch/20427492/working
...Fri Jun 11 13:04:40 CEST 2021: Parse_variables - done
...time taken: 0

...Fri Jun 11 13:04:40 CEST 2021: Init - begin

...Fri Jun 11 13:04:40 CEST 2021: Init - done
...time taken: 0

...Fri Jun 11 13:04:40 CEST 2021: Send - begin

...Fri Jun 11 13:12:53 CEST 2021: Send - done
...time taken: 8

...Fri Jun 11 13:12:53 CEST 2021: Decompress - begin

...Fri Jun 11 13:19:31 CEST 2021: Decompress - done
...time taken: 7

...Fri Jun 11 13:19:31 CEST 2021: Trim - begin

AlienTrimmer main options: -k 10 -l 45 -m 5 -q 20 -p 40 (Phred+33)  /  439 fwd alien sequence(s)  /  7856 fwd k-mers (k=10)  /  439 rev alien sequence(s)  /  7856 rev k-mers (k=10)
[01:55]   1,000,000 read pairs processed:     635,772 trimmed (fwd:     303,260  rev:     332,512)      12,495 removed (fwd:       4,794  rev:       7,701)
[03:50]   2,000,000 read pairs processed:   1,257,838 trimmed (fwd:     596,346  rev:     661,492)      24,782 removed (fwd:       9,319  rev:      15,463)
[05:47]   3,000,000 read pairs processed:   1,889,257 trimmed (fwd:     887,365  rev:   1,001,892)      36,744 removed (fwd:      13,441  rev:      23,303)
[07:46]   4,000,000 read pairs processed:   2,517,868 trimmed (fwd:   1,175,939  rev:   1,341,929)      49,120 removed (fwd:      17,271  rev:      31,849)
[09:41]   5,000,000 read pairs processed:   3,141,972 trimmed (fwd:   1,472,930  rev:   1,669,042)      60,967 removed (fwd:      21,717  rev:      39,250)
[11:35]   6,000,000 read pairs processed:   3,757,276 trimmed (fwd:   1,761,684  rev:   1,995,592)      72,517 removed (fwd:      25,881  rev:      46,636)
[13:32]   7,000,000 read pairs processed:   4,374,683 trimmed (fwd:   2,048,149  rev:   2,326,534)      84,365 removed (fwd:      29,931  rev:      54,434)
[15:27]   8,000,000 read pairs processed:   5,006,242 trimmed (fwd:   2,337,193  rev:   2,669,049)      96,575 removed (fwd:      33,711  rev:      62,864)
[17:21]   9,000,000 read pairs processed:   5,629,652 trimmed (fwd:   2,632,436  rev:   2,997,216)     108,299 removed (fwd:      37,986  rev:      70,313)
[19:15]  10,000,000 read pairs processed:   6,245,461 trimmed (fwd:   2,921,093  rev:   3,324,368)     119,937 removed (fwd:      42,087  rev:      77,850)
[21:10]  11,000,000 read pairs processed:   6,864,705 trimmed (fwd:   3,206,487  rev:   3,658,218)     131,550 removed (fwd:      45,985  rev:      85,565)
[23:07]  12,000,000 read pairs processed:   7,493,140 trimmed (fwd:   3,494,290  rev:   3,998,850)     143,665 removed (fwd:      49,806  rev:      93,859)
[25:00]  13,000,000 read pairs processed:   8,099,572 trimmed (fwd:   3,780,481  rev:   4,319,091)     154,873 removed (fwd:      53,948  rev:     100,925)
[26:55]  14,000,000 read pairs processed:   8,706,072 trimmed (fwd:   4,063,624  rev:   4,642,448)     166,406 removed (fwd:      58,011  rev:     108,395)
[28:48]  15,000,000 read pairs processed:   9,316,958 trimmed (fwd:   4,346,396  rev:   4,970,562)     177,671 removed (fwd:      61,820  rev:     115,851)
[30:45]  16,000,000 read pairs processed:   9,941,718 trimmed (fwd:   4,632,670  rev:   5,309,048)     189,351 removed (fwd:      65,599  rev:     123,752)
[32:38]  17,000,000 read pairs processed:  10,557,250 trimmed (fwd:   4,920,771  rev:   5,636,479)     200,526 removed (fwd:      69,681  rev:     130,845)
[34:34]  18,000,000 read pairs processed:  11,174,905 trimmed (fwd:   5,205,886  rev:   5,969,019)     211,780 removed (fwd:      73,679  rev:     138,101)
[36:30]  19,000,000 read pairs processed:  11,791,621 trimmed (fwd:   5,489,208  rev:   6,302,413)     222,785 removed (fwd:      77,511  rev:     145,274)
[38:28]  20,000,000 read pairs processed:  12,414,232 trimmed (fwd:   5,775,741  rev:   6,638,491)     234,039 removed (fwd:      81,308  rev:     152,731)
[40:22]  21,000,000 read pairs processed:  13,026,588 trimmed (fwd:   6,069,383  rev:   6,957,205)     245,981 removed (fwd:      85,958  rev:     160,023)
[42:18]  22,000,000 read pairs processed:  13,634,457 trimmed (fwd:   6,356,969  rev:   7,277,488)     257,467 removed (fwd:      90,245  rev:     167,222)
[44:13]  23,000,000 read pairs processed:  14,235,164 trimmed (fwd:   6,638,455  rev:   7,596,709)     268,882 removed (fwd:      94,390  rev:     174,492)
[46:09]  24,000,000 read pairs processed:  14,867,530 trimmed (fwd:   6,931,913  rev:   7,935,617)     280,310 removed (fwd:      98,239  rev:     182,071)
[48:08]  25,000,000 read pairs processed:  15,657,979 trimmed (fwd:   7,298,819  rev:   8,359,160)     294,749 removed (fwd:     102,913  rev:     191,836)
[50:04]  26,000,000 read pairs processed:  16,386,058 trimmed (fwd:   7,637,236  rev:   8,748,822)     308,939 removed (fwd:     107,537  rev:     201,402)
[52:02]  27,000,000 read pairs processed:  17,057,501 trimmed (fwd:   7,949,902  rev:   9,107,599)     320,830 removed (fwd:     111,977  rev:     208,853)
[54:00]  28,000,000 read pairs processed:  17,756,015 trimmed (fwd:   8,274,183  rev:   9,481,832)     333,090 removed (fwd:     116,383  rev:     216,707)
[55:57]  29,000,000 read pairs processed:  18,491,308 trimmed (fwd:   8,612,242  rev:   9,879,066)     345,732 removed (fwd:     120,876  rev:     224,856)
[57:53]  30,000,000 read pairs processed:  19,175,554 trimmed (fwd:   8,927,400  rev:  10,248,154)     357,705 removed (fwd:     125,298  rev:     232,407)
[59:47]  31,000,000 read pairs processed:  19,842,224 trimmed (fwd:   9,232,360  rev:  10,609,864)     369,706 removed (fwd:     129,608  rev:     240,098)
[61:42]  32,000,000 read pairs processed:  20,525,973 trimmed (fwd:   9,551,582  rev:  10,974,391)     381,580 removed (fwd:     134,042  rev:     247,538)
[63:38]  33,000,000 read pairs processed:  21,207,784 trimmed (fwd:   9,869,816  rev:  11,337,968)     393,584 removed (fwd:     138,604  rev:     254,980)
[65:33]  34,000,000 read pairs processed:  21,876,506 trimmed (fwd:  10,181,244  rev:  11,695,262)     405,681 removed (fwd:     143,191  rev:     262,490)
[67:29]  35,000,000 read pairs processed:  22,533,848 trimmed (fwd:  10,483,573  rev:  12,050,275)     417,321 removed (fwd:     147,264  rev:     270,057)
[69:24]  36,000,000 read pairs processed:  23,203,716 trimmed (fwd:  10,794,571  rev:  12,409,145)     428,724 removed (fwd:     151,555  rev:     277,169)
[71:20]  37,000,000 read pairs processed:  23,864,277 trimmed (fwd:  11,100,734  rev:  12,763,543)     440,405 removed (fwd:     155,995  rev:     284,410)
[73:13]  38,000,000 read pairs processed:  24,523,995 trimmed (fwd:  11,404,869  rev:  13,119,126)     451,894 removed (fwd:     160,276  rev:     291,618)
[75:07]  39,000,000 read pairs processed:  25,176,600 trimmed (fwd:  11,703,035  rev:  13,473,565)     463,094 removed (fwd:     164,218  rev:     298,876)
[77:02]  40,000,000 read pairs processed:  25,847,713 trimmed (fwd:  12,019,962  rev:  13,827,751)     474,720 removed (fwd:     168,574  rev:     306,146)
[78:57]  41,000,000 read pairs processed:  26,510,637 trimmed (fwd:  12,329,399  rev:  14,181,238)     486,473 removed (fwd:     172,988  rev:     313,485)
[80:51]  42,000,000 read pairs processed:  27,171,273 trimmed (fwd:  12,636,969  rev:  14,534,304)     498,048 removed (fwd:     177,251  rev:     320,797)
