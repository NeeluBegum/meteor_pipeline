...Fri Jun 11 13:15:31 CEST 2021: - begin running script
#!/bin/bash -l
#SBATCH --account=snic2021-5-248
#SBATCH --partition=core
#SBATCH --ntasks=10
#SBATCH --time=2-06:00:00
#SBATCH --job-name=FMT_last_batch
##SBATCH --output=%j 
##SBATCH --mail-user=zn.tportlock@gmail.com
##SBATCH --mail-type=ALL

function Run {
	start=$(date +%M)
	echo "...$(date): $1 - begin"; echo ""
	$@ \
	&& (echo "...$(date): $1 - done") \
	|| (echo "...$(date): $1 - failed")
	end=$(date +%M)
	echo "...time taken: $((end-start))"; echo ""
}
function Parse_variables {
	sampleId=$(basename $sample .fastq.gz)
	v_project_dir="$TMPDIR"
	v_prefix=$( grep "meteor.counting.prefix.name" $ini_file | sed "s/^.*=//g" )
	v_workdir="${v_project_dir}/working"
	v_refdir="${v_project_dir}/reference"
	v_fastqgz1="$(readlink -f $seq_data_dir/${sample}${forward_identifier})"
	v_fastqgz2="$(readlink -f $seq_data_dir/${sample}${reverse_identifier})"
	v_fastqgz1_unzip="${v_workdir}/$(basename $v_fastqgz1 .gz).unzipped"
	v_fastqgz2_unzip="${v_workdir}/$(basename $v_fastqgz2 .gz).unzipped"
	v_trimmedS="${v_workdir}/${sampleId}.trimmed.s.fastq"
	v_final1="${v_workdir}/${sampleId}_1.fastq"
	v_final2="${v_workdir}/${sampleId}_2.fastq"
	v_sampledir="${v_project_dir}/${catalog_type}/sample/${sampleId}"
	vars="$(compgen -A variable | grep "^v_.*")"
	for var in ${vars}; do echo "${var}=${!var}"; done
	for var in ${vars}; do if [[ -z "${!var}" ]]; then echo "missing argument ${var}" ; return 1 ; fi ; done
}
function Init {
	mkdir -p ${v_project_dir}/${catalog_type}/{sample,mapping,profiles}
	mkdir -p ${v_workdir}
	mkdir -p ${v_refdir}
}
function Send {
	cp $v_fastqgz1 $v_workdir
	cp $v_fastqgz2 $v_workdir
	cp -r ${reference_dir}/* $v_refdir
	cp -r $trimFasta $v_project_dir
}
function Decompress {
	zcat ${v_workdir}/$(basename $v_fastqgz1) > $v_fastqgz1_unzip & pid1=$!
	zcat ${v_workdir}/$(basename $v_fastqgz2) > $v_fastqgz2_unzip & pid2=$!
	trap "kill -2 $pid1 $pid2" SIGINT
	wait
}
function Trim {
	[[ -f $v_fastqgz1_unzip && -f $v_fastqgz2_unzip ]] \
	|| (echo "zip file not found" ; return 1 )
	java -jar ${ALIEN_TRIMMER}/AlienTrimmer.jar \
		-k 10 -l 45 -m 5 -p 40 -q 20 \
		-if ${v_fastqgz1_unzip} -ir ${v_fastqgz2_unzip} -c $TMPDIR/$(basename $trimFasta) \
		-of ${v_final1} -or ${v_final2} -os ${v_trimmedS} \
	|| return 1
}
function Import {
	[[ -f $v_final1 && -f $v_final2 ]] \
	|| (echo "trimmed files not found" ; return 1 )
	mv ${v_final1} ${v_final2} ${v_project_dir}/${catalog_type}/sample &&
	rm -r ${v_workdir}
	ruby ${meteorImportScript} \
		-i ${v_project_dir}/${catalog_type}/sample \
		-p ${catalog_type} \
		-t ${seq_platform} \
		-m "${sampleId}*" \
	|| return 1
}
function Map_reads {
	ruby ${meteor}/meteor.rb \
		-w ${ini_file} \
		-i ${v_sampledir} \
		-p ${v_project_dir}/${catalog_type} \
		-o mapping \
	|| return 1
}
function Quantify {
	${meteor}/meteor-profiler \
		-p ${v_project_dir}/${catalog_type} \
		-f ${v_project_dir}/${catalog_type}/profiles \
		-t smart_shared_reads \
		-w ${ini_file} \
		-o ${sampleId} ${v_project_dir}/${catalog_type}/mapping/${sampleId}/${sampleId}_${v_prefix}_gene_profile/census.dat \
	&& rm -r ${v_project_dir}/${catalog_type}/mapping/${sampleId} \
	|| return 1
}
function Recover {
	rsync -aurvP --remove-source-files $v_project_dir/ $project_dir_rel
}

Main() {
	Run Parse_variables &&
	Run Init &&
	Run Send &&
	Run Decompress &&
	Run Trim &&
	Run Import &&
	Run Map_reads &&
	Run Quantify &&
	Run Recover
}

echo "...$(date): - begin running script"
cat $0
echo ""

# Load modules
echo "...$(date): - load modules"
module load bioinfo-tools
module load ruby/2.6.2
module load AlienTrimmer/0.4.0
module load bowtie2/2.3.4.1
echo "...$(date): - done"; echo "" 

# Load ini file
echo "...$(date): - load ini file"
echo $TMPDIR/$(basename $1)
sed "s|meteor.reference.dir=.*|meteor.reference.dir=$TMPDIR/reference|g" $1 > $TMPDIR/$(basename $1)
ini_file=$TMPDIR/$(basename $1)
source $ini_file > /dev/null 2>&1
cat $ini_file
echo "...$(date): - done"; echo "" 

# Run
Main

...Fri Jun 11 13:15:31 CEST 2021: - load modules
Bowtie2 looks for the specified index first in the current directory, then in the directory specified in the BOWTIE2_INDEXES environment variable.
The pregenerated indexes for the reference genonomes are placed under /sw/data/reference/*/*/program_files/bowtie2 for each reference genome
...Fri Jun 11 13:15:39 CEST 2021: - done

...Fri Jun 11 13:15:39 CEST 2021: - load ini file
/scratch/20427495/P18161_266_S133_L004.ini
[Pipeline]
sample=P18161_266/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_266_S133_L004
forward_identifier="_R1_001.fastq.gz"
reverse_identifier="_R2_001.fastq.gz"
seq_data_dir="/proj/snic2020-6-153/delivery04021/P18161"
project_dir_rel="/proj/uppstore2019028/projects/metagenome/theo/newscripts/tmp"
catalog_type="oral_catalog"
seq_platform="illumina"
trimFasta="/proj/uppstore2019028/projects/metagenome/alienTrimmerPF8contaminants.fasta"
meteorImportScript="/proj/uppstore2019028/meteor.2019.11.04/MeteorImportFastq.rb"
meteor="/proj/uppstore2019028/projects/metagenome/software/meteor_linux_2019.11.04"
Rdir="/proj/uppstore2019028/projects/metagenome/meteor_downstream_rscripts"
reference_dir="/proj/uppstore2019028/projects/metagenome/meteor_ref"
[worksession]
meteor.reference.dir=/scratch/20427495/reference
meteor.db.type=binary
meteor.nb.attempts=3
meteor.read.cleaning.program=none
meteor.read.cleaning.cmd=
meteor.mapping.program=bowtie2
meteor.mapping.file.format=sam
meteor.is.cpu.percentage=0
meteor.cpu.count=10
meteor.checksum=md5
meteor.excluded.reference.count=3
[main_reference]
meteor.reference.name=oral_catalog
meteor.matches=10000
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapper.cmd=
meteor.mapping.prefix.name=mapping_vs_oral_catalog
meteor.counting.prefix.name=vs_hs_10_4_oral_catalog
[excluded_reference_1]
meteor.reference.name=Homo_sapiens_GRCh38
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Homo_sapiens_GRCh38
[excluded_reference_2]
meteor.reference.name=A_thaliana_TAIR10
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_A_thaliana_TAIR10
[excluded_reference_3]
meteor.reference.name=Bos_taurus_UMD3
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Bos_taurus_UMD3
...Fri Jun 11 13:15:39 CEST 2021: - done

...Fri Jun 11 13:15:39 CEST 2021: Parse_variables - begin

v_fastqgz1=/crex/proj/snic2020-6-153/nobackup/delivery04021/P18161/P18161_266/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_266_S133_L004_R1_001.fastq.gz
v_fastqgz1_unzip=/scratch/20427495/working/P18161_266_S133_L004_R1_001.fastq.unzipped
v_fastqgz2=/crex/proj/snic2020-6-153/nobackup/delivery04021/P18161/P18161_266/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_266_S133_L004_R2_001.fastq.gz
v_fastqgz2_unzip=/scratch/20427495/working/P18161_266_S133_L004_R2_001.fastq.unzipped
v_final1=/scratch/20427495/working/P18161_266_S133_L004_1.fastq
v_final2=/scratch/20427495/working/P18161_266_S133_L004_2.fastq
v_prefix=vs_hs_10_4_oral_catalog
v_project_dir=/scratch/20427495
v_refdir=/scratch/20427495/reference
v_sampledir=/scratch/20427495/oral_catalog/sample/P18161_266_S133_L004
v_trimmedS=/scratch/20427495/working/P18161_266_S133_L004.trimmed.s.fastq
v_workdir=/scratch/20427495/working
...Fri Jun 11 13:15:39 CEST 2021: Parse_variables - done
...time taken: 0

...Fri Jun 11 13:15:39 CEST 2021: Init - begin

...Fri Jun 11 13:15:39 CEST 2021: Init - done
...time taken: 0

...Fri Jun 11 13:15:39 CEST 2021: Send - begin

...Fri Jun 11 13:21:37 CEST 2021: Send - done
...time taken: 6

...Fri Jun 11 13:21:37 CEST 2021: Decompress - begin

...Fri Jun 11 13:28:52 CEST 2021: Decompress - done
...time taken: 7

...Fri Jun 11 13:28:52 CEST 2021: Trim - begin

AlienTrimmer main options: -k 10 -l 45 -m 5 -q 20 -p 40 (Phred+33)  /  439 fwd alien sequence(s)  /  7856 fwd k-mers (k=10)  /  439 rev alien sequence(s)  /  7856 rev k-mers (k=10)
[01:55]   1,000,000 read pairs processed:     776,511 trimmed (fwd:     377,409  rev:     399,102)      20,912 removed (fwd:       9,715  rev:      11,197)
[03:51]   2,000,000 read pairs processed:   1,539,525 trimmed (fwd:     744,630  rev:     794,895)      40,907 removed (fwd:      18,848  rev:      22,059)
[05:49]   3,000,000 read pairs processed:   2,300,957 trimmed (fwd:   1,106,582  rev:   1,194,375)      60,066 removed (fwd:      27,403  rev:      32,663)
[07:44]   4,000,000 read pairs processed:   3,068,267 trimmed (fwd:   1,477,375  rev:   1,590,892)      80,696 removed (fwd:      36,954  rev:      43,742)
[09:41]   5,000,000 read pairs processed:   3,821,921 trimmed (fwd:   1,840,001  rev:   1,981,920)     100,661 removed (fwd:      46,169  rev:      54,492)
[11:38]   6,000,000 read pairs processed:   4,578,141 trimmed (fwd:   2,199,866  rev:   2,378,275)     120,188 removed (fwd:      55,013  rev:      65,175)
[13:36]   7,000,000 read pairs processed:   5,352,374 trimmed (fwd:   2,570,719  rev:   2,781,655)     140,550 removed (fwd:      64,288  rev:      76,262)
[15:33]   8,000,000 read pairs processed:   6,108,517 trimmed (fwd:   2,934,375  rev:   3,174,142)     160,402 removed (fwd:      73,422  rev:      86,980)
[17:30]   9,000,000 read pairs processed:   6,866,262 trimmed (fwd:   3,295,500  rev:   3,570,762)     179,923 removed (fwd:      82,161  rev:      97,762)
[19:26]  10,000,000 read pairs processed:   7,631,920 trimmed (fwd:   3,659,231  rev:   3,972,689)     199,652 removed (fwd:      91,046  rev:     108,606)
[21:22]  11,000,000 read pairs processed:   8,381,556 trimmed (fwd:   4,020,125  rev:   4,361,431)     219,404 removed (fwd:     100,124  rev:     119,280)
[23:19]  12,000,000 read pairs processed:   9,131,207 trimmed (fwd:   4,378,566  rev:   4,752,641)     238,711 removed (fwd:     108,944  rev:     129,767)
[25:16]  13,000,000 read pairs processed:   9,888,321 trimmed (fwd:   4,737,600  rev:   5,150,721)     258,184 removed (fwd:     117,701  rev:     140,483)
[27:12]  14,000,000 read pairs processed:  10,649,312 trimmed (fwd:   5,103,100  rev:   5,546,212)     278,116 removed (fwd:     126,965  rev:     151,151)
[29:10]  15,000,000 read pairs processed:  11,405,863 trimmed (fwd:   5,463,154  rev:   5,942,709)     297,859 removed (fwd:     135,975  rev:     161,884)
[31:08]  16,000,000 read pairs processed:  12,162,539 trimmed (fwd:   5,822,218  rev:   6,340,321)     317,104 removed (fwd:     144,646  rev:     172,458)
[33:04]  17,000,000 read pairs processed:  12,924,323 trimmed (fwd:   6,190,769  rev:   6,733,554)     337,322 removed (fwd:     153,975  rev:     183,347)
[34:59]  18,000,000 read pairs processed:  13,674,838 trimmed (fwd:   6,555,237  rev:   7,119,601)     357,404 removed (fwd:     163,348  rev:     194,056)
[36:56]  19,000,000 read pairs processed:  14,421,017 trimmed (fwd:   6,914,583  rev:   7,506,434)     377,290 removed (fwd:     172,377  rev:     204,913)
[38:54]  20,000,000 read pairs processed:  15,242,184 trimmed (fwd:   7,305,730  rev:   7,936,454)     397,900 removed (fwd:     181,444  rev:     216,456)
[40:52]  21,000,000 read pairs processed:  16,135,122 trimmed (fwd:   7,730,233  rev:   8,404,889)     421,354 removed (fwd:     191,134  rev:     230,220)
[42:51]  22,000,000 read pairs processed:  16,954,721 trimmed (fwd:   8,123,306  rev:   8,831,415)     443,707 removed (fwd:     201,454  rev:     242,253)
[44:49]  23,000,000 read pairs processed:  17,778,654 trimmed (fwd:   8,515,823  rev:   9,262,831)     465,286 removed (fwd:     211,274  rev:     254,012)
[46:46]  24,000,000 read pairs processed:  18,633,060 trimmed (fwd:   8,920,313  rev:   9,712,747)     486,700 removed (fwd:     220,845  rev:     265,855)
[48:42]  25,000,000 read pairs processed:  19,453,175 trimmed (fwd:   9,308,140  rev:  10,145,035)     508,833 removed (fwd:     230,843  rev:     277,990)
[50:38]  26,000,000 read pairs processed:  20,264,263 trimmed (fwd:   9,692,553  rev:  10,571,710)     530,417 removed (fwd:     240,572  rev:     289,845)
[52:34]  27,000,000 read pairs processed:  21,092,705 trimmed (fwd:  10,089,224  rev:  11,003,481)     552,172 removed (fwd:     250,444  rev:     301,728)
[54:33]  28,000,000 read pairs processed:  21,907,013 trimmed (fwd:  10,477,404  rev:  11,429,609)     574,547 removed (fwd:     260,727  rev:     313,820)
[56:31]  29,000,000 read pairs processed:  22,709,284 trimmed (fwd:  10,857,215  rev:  11,852,069)     595,948 removed (fwd:     270,347  rev:     325,601)
[58:28]  30,000,000 read pairs processed:  23,517,612 trimmed (fwd:  11,243,022  rev:  12,274,590)     617,597 removed (fwd:     280,241  rev:     337,356)
[60:24]  31,000,000 read pairs processed:  24,322,752 trimmed (fwd:  11,625,437  rev:  12,697,315)     639,023 removed (fwd:     290,016  rev:     349,007)
[62:20]  32,000,000 read pairs processed:  25,122,379 trimmed (fwd:  12,003,752  rev:  13,118,627)     660,128 removed (fwd:     299,518  rev:     360,610)
[64:17]  33,000,000 read pairs processed:  25,933,141 trimmed (fwd:  12,392,070  rev:  13,541,071)     681,927 removed (fwd:     309,457  rev:     372,470)
[66:13]  34,000,000 read pairs processed:  26,738,735 trimmed (fwd:  12,777,695  rev:  13,961,040)     703,867 removed (fwd:     319,570  rev:     384,297)
[68:11]  35,000,000 read pairs processed:  27,539,915 trimmed (fwd:  13,159,234  rev:  14,380,681)     725,247 removed (fwd:     329,328  rev:     395,919)
[71:08]  36,000,000 read pairs processed:  28,376,552 trimmed (fwd:  13,557,976  rev:  14,818,576)     748,007 removed (fwd:     339,888  rev:     408,119)
[73:05]  37,000,000 read pairs processed:  29,204,388 trimmed (fwd:  13,954,223  rev:  15,250,165)     770,877 removed (fwd:     350,508  rev:     420,369)
