[?1034h[?1034h...Wed Jun 30 17:12:39 CEST 2021: - begin running script
#!/bin/bash -l
#SBATCH --account=snic2021-5-248
##SBATCH --partition=core
#SBATCH -p node -n 1
##SBATCH --ntasks=10
##SBATCH --time=1-00:00:00
#SBATCH --time=08:00:00
#SBATCH --job-name=Downstrm
##SBATCH --mail-user=zn.tportlock@gmail.com
##SBATCH --mail-type=ALL
##SBATCH --output=/proj/uppstore2019028/projects/metagenome/theo/newscripts/meteor/logs/%j 

function Run {
	echo "...$(date): $1 - begin"; echo ""
	$@ \
	&& (echo "...$(date): $1 - done"; echo "") \
	|| (echo "...$(date): $1 - failed"; echo ""; return 1)
}
function Parse_variables {
	v_project_dir=$project_dir_rel
	v_downstream_dir="$v_project_dir/Downstream"
	v_ref_name=$( grep "meteor.reference.name" $ini_file | sed "s/^.*=//g" )
	vars="$(compgen -A variable | grep "^v_.*")"
	for var in ${vars}; do echo "${var}=${!var}"; done
	for var in ${vars}; do if [[ -z "${!var}" ]]; then echo "missing argument ${var}" ; return 1 ; fi ; done
}
function Init {
	mkdir -p $v_downstream_dir
}
function PrepareReports {
	inFile=$v_downstream_dir/$1.csv
	outFile=$v_downstream_dir/$1.final.csv
	cat $v_project_dir/$catalog_type/profiles/*$1.csv > $inFile
	head -1 $inFile > ${outFile}.header
	cat $inFile | grep -v sample > ${outFile}.body
	cat ${outFile}.header ${outFile}.body > ${outFile}
	rm ${inFile} ${outFile}.header ${outFile}.body
}
function PrepareGCT {
	inFile=$v_downstream_dir/pre_gct.tsv
	outFile=$v_downstream_dir/gct.tsv
	paste $v_project_dir/$catalog_type/profiles/*.tsv > $inFile
	width=$(head -1 $inFile | awk '{print NF}')
	echo $width
	cat $inFile | cut -f1 | sed 's/\#id_fragment/gene_id/g' > ${outFile}.gene
	cat $inFile | awk -v width="$width" 'BEGIN{OFS="\t"}{s="";for(i=2;i<=width;i=i+2){if (i!=width)s=s $i "\t"; if (i==width) s=s $i}; print s}' > ${outFile}.expr
	paste ${outFile}.gene ${outFile}.expr > ${outFile}
	rm ${inFile} ${outFile}.gene ${outFile}.expr
}
function GetMGS {
	Rscript $wrapper_dir/downstream.r \
		$v_downstream_dir/gct.tsv \
		$v_downstream_dir \
		$reference_dir/${meteor.reference.name}/database/${meteor.reference.name}_lite_annotation \
		$msp_dir \
	|| return 1
}

Downstream() {
	Run Parse_variables &&
	Run Init #&&
	#Run PrepareReports counting_report &&
	#Run PrepareReports extended_counting_report &&
	#Run GetMGS
}

echo "...$(date): - begin running script"
cat $0
echo ""

# Load ini file
echo "...$(date): - load ini file"
ini_file=$1
source $ini_file > /dev/null 2>&1
cat $ini_file
echo "...$(date): - done"; echo "" 

# Run the downstream analysis
Downstream

...Wed Jun 30 17:12:39 CEST 2021: - load ini file
[Pipeline]
sample=P18161_205/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_205_S79_L004
forward_identifier="_R1_001.fastq.gz"
reverse_identifier="_R2_001.fastq.gz"
seq_data_dir="/proj/snic2020-6-153/delivery04021/P18161"
project_dir_rel="/home/theop/project"
catalog_type="gut_catalog"
seq_platform="illumina"
trimFasta="/proj/uppstore2019028/projects/metagenome/alienTrimmerPF8contaminants.fasta"
meteor_rep="/proj/uppstore2019028/projects/metagenome/software/meteor"
wrapper_dir="/proj/uppstore2019028/projects/metagenome/theo/newscripts/meteor"
reference_dir="/proj/uppstore2019028/projects/metagenome/meteor_ref"
[worksession]
meteor.reference.dir=/scratch/20410259/reference
meteor.db.type=binary
meteor.nb.attempts=3
meteor.read.cleaning.program=none
meteor.read.cleaning.cmd=
meteor.mapping.program=bowtie2
meteor.mapping.file.format=sam
meteor.is.cpu.percentage=0
meteor.cpu.count=10
meteor.checksum=md5
meteor.excluded.reference.count=3
[main_reference]
meteor.reference.name=oral_catalog
meteor.matches=10000
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapper.cmd=
meteor.mapping.prefix.name=mapping_vs_oral_catalog
meteor.counting.prefix.name=vs_hs_10_4_oral_catalog
[excluded_reference_1]
meteor.reference.name=Homo_sapiens_GRCh38
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Homo_sapiens_GRCh38
[excluded_reference_2]
meteor.reference.name=A_thaliana_TAIR10
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_A_thaliana_TAIR10
[excluded_reference_3]
meteor.reference.name=Bos_taurus_UMD3
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Bos_taurus_UMD3
...Wed Jun 30 17:12:39 CEST 2021: - done

...Wed Jun 30 17:12:39 CEST 2021: Parse_variables - begin

v_downstream_dir=/home/theop/project/Downstream
v_project_dir=/home/theop/project
v_ref_name=oral_catalog
Homo_sapiens_GRCh38
A_thaliana_TAIR10
Bos_taurus_UMD3
...Wed Jun 30 17:12:39 CEST 2021: Parse_variables - done

...Wed Jun 30 17:12:39 CEST 2021: Init - begin

...Wed Jun 30 17:12:39 CEST 2021: Init - done

