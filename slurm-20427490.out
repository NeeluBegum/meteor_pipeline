...Fri Jun 11 13:04:32 CEST 2021: - begin running script
#!/bin/bash -l
#SBATCH --account=snic2021-5-248
#SBATCH --partition=core
#SBATCH --ntasks=10
#SBATCH --time=2-06:00:00
#SBATCH --job-name=FMT_last_batch
##SBATCH --output=%j 
##SBATCH --mail-user=zn.tportlock@gmail.com
##SBATCH --mail-type=ALL

function Run {
	start=$(date +%M)
	echo "...$(date): $1 - begin"; echo ""
	$@ \
	&& (echo "...$(date): $1 - done") \
	|| (echo "...$(date): $1 - failed")
	end=$(date +%M)
	echo "...time taken: $((end-start))"; echo ""
}
function Parse_variables {
	sampleId=$(basename $sample .fastq.gz)
	v_project_dir="$TMPDIR"
	v_prefix=$( grep "meteor.counting.prefix.name" $ini_file | sed "s/^.*=//g" )
	v_workdir="${v_project_dir}/working"
	v_refdir="${v_project_dir}/reference"
	v_fastqgz1="$(readlink -f $seq_data_dir/${sample}${forward_identifier})"
	v_fastqgz2="$(readlink -f $seq_data_dir/${sample}${reverse_identifier})"
	v_fastqgz1_unzip="${v_workdir}/$(basename $v_fastqgz1 .gz).unzipped"
	v_fastqgz2_unzip="${v_workdir}/$(basename $v_fastqgz2 .gz).unzipped"
	v_trimmedS="${v_workdir}/${sampleId}.trimmed.s.fastq"
	v_final1="${v_workdir}/${sampleId}_1.fastq"
	v_final2="${v_workdir}/${sampleId}_2.fastq"
	v_sampledir="${v_project_dir}/${catalog_type}/sample/${sampleId}"
	vars="$(compgen -A variable | grep "^v_.*")"
	for var in ${vars}; do echo "${var}=${!var}"; done
	for var in ${vars}; do if [[ -z "${!var}" ]]; then echo "missing argument ${var}" ; return 1 ; fi ; done
}
function Init {
	mkdir -p ${v_project_dir}/${catalog_type}/{sample,mapping,profiles}
	mkdir -p ${v_workdir}
	mkdir -p ${v_refdir}
}
function Send {
	cp $v_fastqgz1 $v_workdir
	cp $v_fastqgz2 $v_workdir
	cp -r ${reference_dir}/* $v_refdir
	cp -r $trimFasta $v_project_dir
}
function Decompress {
	zcat ${v_workdir}/$(basename $v_fastqgz1) > $v_fastqgz1_unzip & pid1=$!
	zcat ${v_workdir}/$(basename $v_fastqgz2) > $v_fastqgz2_unzip & pid2=$!
	trap "kill -2 $pid1 $pid2" SIGINT
	wait
}
function Trim {
	[[ -f $v_fastqgz1_unzip && -f $v_fastqgz2_unzip ]] \
	|| (echo "zip file not found" ; return 1 )
	java -jar ${ALIEN_TRIMMER}/AlienTrimmer.jar \
		-k 10 -l 45 -m 5 -p 40 -q 20 \
		-if ${v_fastqgz1_unzip} -ir ${v_fastqgz2_unzip} -c $TMPDIR/$(basename $trimFasta) \
		-of ${v_final1} -or ${v_final2} -os ${v_trimmedS} \
	|| return 1
}
function Import {
	[[ -f $v_final1 && -f $v_final2 ]] \
	|| (echo "trimmed files not found" ; return 1 )
	mv ${v_final1} ${v_final2} ${v_project_dir}/${catalog_type}/sample &&
	rm -r ${v_workdir}
	ruby ${meteorImportScript} \
		-i ${v_project_dir}/${catalog_type}/sample \
		-p ${catalog_type} \
		-t ${seq_platform} \
		-m "${sampleId}*" \
	|| return 1
}
function Map_reads {
	ruby ${meteor}/meteor.rb \
		-w ${ini_file} \
		-i ${v_sampledir} \
		-p ${v_project_dir}/${catalog_type} \
		-o mapping \
	|| return 1
}
function Quantify {
	${meteor}/meteor-profiler \
		-p ${v_project_dir}/${catalog_type} \
		-f ${v_project_dir}/${catalog_type}/profiles \
		-t smart_shared_reads \
		-w ${ini_file} \
		-o ${sampleId} ${v_project_dir}/${catalog_type}/mapping/${sampleId}/${sampleId}_${v_prefix}_gene_profile/census.dat \
	&& rm -r ${v_project_dir}/${catalog_type}/mapping/${sampleId} \
	|| return 1
}
function Recover {
	rsync -aurvP --remove-source-files $v_project_dir/ $project_dir_rel
}

Main() {
	Run Parse_variables &&
	Run Init &&
	Run Send &&
	Run Decompress &&
	Run Trim &&
	Run Import &&
	Run Map_reads &&
	Run Quantify &&
	Run Recover
}

echo "...$(date): - begin running script"
cat $0
echo ""

# Load modules
echo "...$(date): - load modules"
module load bioinfo-tools
module load ruby/2.6.2
module load AlienTrimmer/0.4.0
module load bowtie2/2.3.4.1
echo "...$(date): - done"; echo "" 

# Load ini file
echo "...$(date): - load ini file"
echo $TMPDIR/$(basename $1)
sed "s|meteor.reference.dir=.*|meteor.reference.dir=$TMPDIR/reference|g" $1 > $TMPDIR/$(basename $1)
ini_file=$TMPDIR/$(basename $1)
source $ini_file > /dev/null 2>&1
cat $ini_file
echo "...$(date): - done"; echo "" 

# Run
Main

...Fri Jun 11 13:04:32 CEST 2021: - load modules
Bowtie2 looks for the specified index first in the current directory, then in the directory specified in the BOWTIE2_INDEXES environment variable.
The pregenerated indexes for the reference genonomes are placed under /sw/data/reference/*/*/program_files/bowtie2 for each reference genome
...Fri Jun 11 13:04:40 CEST 2021: - done

...Fri Jun 11 13:04:40 CEST 2021: - load ini file
/scratch/20427490/P18161_247_S118_L004.ini
[Pipeline]
sample=P18161_247/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_247_S118_L004
forward_identifier="_R1_001.fastq.gz"
reverse_identifier="_R2_001.fastq.gz"
seq_data_dir="/proj/snic2020-6-153/delivery04021/P18161"
project_dir_rel="/proj/uppstore2019028/projects/metagenome/theo/newscripts/tmp"
catalog_type="oral_catalog"
seq_platform="illumina"
trimFasta="/proj/uppstore2019028/projects/metagenome/alienTrimmerPF8contaminants.fasta"
meteorImportScript="/proj/uppstore2019028/meteor.2019.11.04/MeteorImportFastq.rb"
meteor="/proj/uppstore2019028/projects/metagenome/software/meteor_linux_2019.11.04"
Rdir="/proj/uppstore2019028/projects/metagenome/meteor_downstream_rscripts"
reference_dir="/proj/uppstore2019028/projects/metagenome/meteor_ref"
[worksession]
meteor.reference.dir=/scratch/20427490/reference
meteor.db.type=binary
meteor.nb.attempts=3
meteor.read.cleaning.program=none
meteor.read.cleaning.cmd=
meteor.mapping.program=bowtie2
meteor.mapping.file.format=sam
meteor.is.cpu.percentage=0
meteor.cpu.count=10
meteor.checksum=md5
meteor.excluded.reference.count=3
[main_reference]
meteor.reference.name=oral_catalog
meteor.matches=10000
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapper.cmd=
meteor.mapping.prefix.name=mapping_vs_oral_catalog
meteor.counting.prefix.name=vs_hs_10_4_oral_catalog
[excluded_reference_1]
meteor.reference.name=Homo_sapiens_GRCh38
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Homo_sapiens_GRCh38
[excluded_reference_2]
meteor.reference.name=A_thaliana_TAIR10
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_A_thaliana_TAIR10
[excluded_reference_3]
meteor.reference.name=Bos_taurus_UMD3
meteor.matches=1
meteor.mismatches=5
meteor.is.perc.mismatches=1
meteor.bestalignment=1
meteor.mapping.prefix.name=mapping_vs_Bos_taurus_UMD3
...Fri Jun 11 13:04:40 CEST 2021: - done

...Fri Jun 11 13:04:40 CEST 2021: Parse_variables - begin

v_fastqgz1=/crex/proj/snic2020-6-153/nobackup/delivery04021/P18161/P18161_247/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_247_S118_L004_R1_001.fastq.gz
v_fastqgz1_unzip=/scratch/20427490/working/P18161_247_S118_L004_R1_001.fastq.unzipped
v_fastqgz2=/crex/proj/snic2020-6-153/nobackup/delivery04021/P18161/P18161_247/02-FASTQ/201104_A00187_0373_BHGM2CDSXY/P18161_247_S118_L004_R2_001.fastq.gz
v_fastqgz2_unzip=/scratch/20427490/working/P18161_247_S118_L004_R2_001.fastq.unzipped
v_final1=/scratch/20427490/working/P18161_247_S118_L004_1.fastq
v_final2=/scratch/20427490/working/P18161_247_S118_L004_2.fastq
v_prefix=vs_hs_10_4_oral_catalog
v_project_dir=/scratch/20427490
v_refdir=/scratch/20427490/reference
v_sampledir=/scratch/20427490/oral_catalog/sample/P18161_247_S118_L004
v_trimmedS=/scratch/20427490/working/P18161_247_S118_L004.trimmed.s.fastq
v_workdir=/scratch/20427490/working
...Fri Jun 11 13:04:41 CEST 2021: Parse_variables - done
...time taken: 0

...Fri Jun 11 13:04:41 CEST 2021: Init - begin

...Fri Jun 11 13:04:41 CEST 2021: Init - done
...time taken: 0

...Fri Jun 11 13:04:41 CEST 2021: Send - begin

...Fri Jun 11 13:11:48 CEST 2021: Send - done
...time taken: 7

...Fri Jun 11 13:11:48 CEST 2021: Decompress - begin

...Fri Jun 11 13:17:06 CEST 2021: Decompress - done
...time taken: 6

...Fri Jun 11 13:17:07 CEST 2021: Trim - begin

AlienTrimmer main options: -k 10 -l 45 -m 5 -q 20 -p 40 (Phred+33)  /  439 fwd alien sequence(s)  /  7856 fwd k-mers (k=10)  /  439 rev alien sequence(s)  /  7856 rev k-mers (k=10)
[01:57]   1,000,000 read pairs processed:     648,312 trimmed (fwd:     294,278  rev:     354,034)      14,962 removed (fwd:       3,979  rev:      10,983)
[03:55]   2,000,000 read pairs processed:   1,298,960 trimmed (fwd:     583,546  rev:     715,414)      29,844 removed (fwd:       7,527  rev:      22,317)
[05:55]   3,000,000 read pairs processed:   1,946,677 trimmed (fwd:     867,045  rev:   1,079,632)      46,798 removed (fwd:      10,955  rev:      35,843)
[07:53]   4,000,000 read pairs processed:   2,585,840 trimmed (fwd:   1,155,697  rev:   1,430,143)      60,384 removed (fwd:      14,546  rev:      45,838)
[09:51]   5,000,000 read pairs processed:   3,225,593 trimmed (fwd:   1,438,883  rev:   1,786,710)      74,713 removed (fwd:      17,991  rev:      56,722)
[11:51]   6,000,000 read pairs processed:   3,875,858 trimmed (fwd:   1,725,000  rev:   2,150,858)      90,989 removed (fwd:      21,337  rev:      69,652)
[13:48]   7,000,000 read pairs processed:   4,513,552 trimmed (fwd:   2,011,402  rev:   2,502,150)     105,014 removed (fwd:      24,844  rev:      80,170)
[15:50]   8,000,000 read pairs processed:   5,156,959 trimmed (fwd:   2,294,625  rev:   2,862,334)     120,109 removed (fwd:      28,179  rev:      91,930)
[17:48]   9,000,000 read pairs processed:   5,800,802 trimmed (fwd:   2,577,741  rev:   3,223,061)     135,613 removed (fwd:      31,462  rev:     104,151)
[19:46]  10,000,000 read pairs processed:   6,428,731 trimmed (fwd:   2,856,731  rev:   3,572,000)     149,430 removed (fwd:      34,844  rev:     114,586)
[21:41]  11,000,000 read pairs processed:   7,061,402 trimmed (fwd:   3,135,699  rev:   3,925,703)     163,767 removed (fwd:      38,261  rev:     125,506)
[23:38]  12,000,000 read pairs processed:   7,705,914 trimmed (fwd:   3,419,425  rev:   4,286,489)     178,305 removed (fwd:      41,446  rev:     136,859)
[25:35]  13,000,000 read pairs processed:   8,342,179 trimmed (fwd:   3,699,646  rev:   4,642,533)     191,898 removed (fwd:      44,792  rev:     147,106)
[27:32]  14,000,000 read pairs processed:   8,983,775 trimmed (fwd:   3,980,549  rev:   5,003,226)     205,493 removed (fwd:      48,151  rev:     157,342)
[29:30]  15,000,000 read pairs processed:   9,622,684 trimmed (fwd:   4,265,365  rev:   5,357,319)     219,592 removed (fwd:      51,570  rev:     168,022)
[31:27]  16,000,000 read pairs processed:  10,252,041 trimmed (fwd:   4,548,909  rev:   5,703,132)     233,478 removed (fwd:      55,239  rev:     178,239)
[33:23]  17,000,000 read pairs processed:  10,873,456 trimmed (fwd:   4,827,719  rev:   6,045,737)     247,045 removed (fwd:      58,760  rev:     188,285)
[35:23]  18,000,000 read pairs processed:  11,592,630 trimmed (fwd:   5,149,275  rev:   6,443,355)     261,853 removed (fwd:      62,204  rev:     199,649)
[37:23]  19,000,000 read pairs processed:  12,337,378 trimmed (fwd:   5,484,830  rev:   6,852,548)     277,632 removed (fwd:      66,070  rev:     211,562)
[39:23]  20,000,000 read pairs processed:  13,015,831 trimmed (fwd:   5,788,759  rev:   7,227,072)     291,148 removed (fwd:      69,632  rev:     221,516)
[41:23]  21,000,000 read pairs processed:  13,772,393 trimmed (fwd:   6,126,951  rev:   7,645,442)     305,918 removed (fwd:      73,325  rev:     232,593)
[43:21]  22,000,000 read pairs processed:  14,470,078 trimmed (fwd:   6,435,785  rev:   8,034,293)     319,016 removed (fwd:      76,961  rev:     242,055)
[45:19]  23,000,000 read pairs processed:  15,154,849 trimmed (fwd:   6,740,947  rev:   8,413,902)     332,798 removed (fwd:      80,403  rev:     252,395)
[47:19]  24,000,000 read pairs processed:  15,856,449 trimmed (fwd:   7,057,029  rev:   8,799,420)     346,278 removed (fwd:      84,260  rev:     262,018)
[49:16]  25,000,000 read pairs processed:  16,528,394 trimmed (fwd:   7,356,319  rev:   9,172,075)     359,038 removed (fwd:      87,779  rev:     271,259)
[51:15]  26,000,000 read pairs processed:  17,208,139 trimmed (fwd:   7,659,066  rev:   9,549,073)     372,173 removed (fwd:      91,406  rev:     280,767)
[53:15]  27,000,000 read pairs processed:  17,883,558 trimmed (fwd:   7,959,619  rev:   9,923,939)     384,737 removed (fwd:      95,030  rev:     289,707)
[55:16]  28,000,000 read pairs processed:  18,550,030 trimmed (fwd:   8,253,328  rev:  10,296,702)     397,591 removed (fwd:      98,447  rev:     299,144)
[57:17]  29,000,000 read pairs processed:  19,234,686 trimmed (fwd:   8,561,380  rev:  10,673,306)     410,671 removed (fwd:     102,168  rev:     308,503)
[59:22]  30,000,000 read pairs processed:  19,912,495 trimmed (fwd:   8,865,703  rev:  11,046,792)     423,788 removed (fwd:     105,907  rev:     317,881)
[61:26]  31,000,000 read pairs processed:  20,594,138 trimmed (fwd:   9,169,002  rev:  11,425,136)     436,957 removed (fwd:     109,218  rev:     327,739)
[64:16]  32,000,000 read pairs processed:  21,315,798 trimmed (fwd:   9,492,921  rev:  11,822,877)     451,162 removed (fwd:     113,378  rev:     337,784)
[66:15]  33,000,000 read pairs processed:  21,996,077 trimmed (fwd:   9,796,685  rev:  12,199,392)     463,872 removed (fwd:     117,084  rev:     346,788)
[67:12]  33,481,659 read pairs processed:  22,315,247 trimmed (fwd:   9,937,420  rev:  12,377,827)     470,055 removed (fwd:     118,726  rev:     351,329)
...Fri Jun 11 14:24:20 CEST 2021: Trim - done
...time taken: 7

...Fri Jun 11 14:24:20 CEST 2021: Import - begin

ruby: warning: shebang line ending with \r may cause problems
Import /scratch/20427490/oral_catalog/sample/P18161_247_S118_L004_2.fastq
Import /scratch/20427490/oral_catalog/sample/P18161_247_S118_L004_1.fastq
Importation done!
...Fri Jun 11 14:24:25 CEST 2021: Import - done
...time taken: 0

...Fri Jun 11 14:24:25 CEST 2021: Map_reads - begin

/proj/uppstore2019028/projects/metagenome/software/meteor_linux_2019.11.04/meteor.rb:146: warning: constant ::Fixnum is deprecated
/proj/uppstore2019028/projects/metagenome/software/meteor_linux_2019.11.04/meteor.rb:161: warning: Insecure world writable dir /proj/uppstore2019028/Helen/meteor-linux.2019-11-04 in PATH, mode 042777

Launch mapping


######### Meteor Mapping task description
Sample name = P18161_247_S118_L004
Library name = P18161_247_S118_L004_1
Project name = oral_catalog
Sequencing device = illumina
Workflow = P18161_247_S118_L004.ini

######### Task main mapping 0
Executing mapping command:
bowtie2-align-l --mm -p 10 --end-to-end --sensitive -k 10000 --no-head --no-sq --no-unal --omit-sec-seq -x /scratch/20427490/reference/oral_catalog/fasta/oral_catalog_dnaspace_index -U /scratch/20427490/oral_catalog/sample/P18161_247_S118_L004/9239b48d8dd4791f87e0018de0f20f04/P18161_247_S118_L004_1.fastq.idx -S /scratch/20427490/oral_catalog/mapping/P18161_247_S118_L004/mapping_vs_oral_catalog_P18161_247_S118_L004_1/P18161_247_S118_L004_1_1.sam
